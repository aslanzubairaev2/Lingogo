# Romanization Fix Summary

## Problem

There was an issue in the application with inconsistent storage of romanization (transcription) for phrases:

1.  **Romanization in parentheses**: Phrases contained romanization directly in the text, for example:
    *   `"नमस्ते (namaste)"` instead of pure text `"नमस्ते"` with a separate romanization field
    *   `"你好 (nǐ hǎo)"` instead of `"你好"` + romanization: `"nǐ hǎo"`

2.  **Romanization in square brackets**: Some phrases used `[romanization]`

3.  **Missing Romanization**: Some phrases had no romanization at all

## Solution

### 1. Data Structure Update

**File: `types.ts`**
*   Added `romanization?: string` field to `ProposedCard` type

```typescript
export type ProposedCard = {
  native: string;
  learning: string;
  romanization?: string;  // ← New field
};
```

### 2. AI Service Update

**File: `services/geminiService.ts`**

Added a function to determine languages requiring romanization:

```typescript
const requiresRomanization = (languageCode: LanguageCode): boolean => {
    return ['ar', 'hi', 'zh', 'ja'].includes(languageCode);
};
```

Updated all schemas for card generation:
*   `categoryAssistantResponseSchema()` - for Category Assistant
*   `cardsFromTranscriptSchema()` - for transcripts
*   `imageCardsWithCategorySchema()` - for generation from images
*   `phraseSchema()` - for generation by topics

Each schema now:
1.  **Adds `romanization` field** for languages that need it (Chinese, Japanese, Hindi, Arabic)
2.  **Explicitly states in the description** that romanization should NOT be in parentheses in the main text
3.  **Makes the field required** for languages with non-Latin scripts

Example schema changes:

```typescript
properties: {
    [lang.learningCode]: {
        type: Type.STRING,
        description: `The phrase in ${lang.learning}. NEVER include romanization/transcription in parentheses here - use the separate romanization field.`
    },
    [lang.nativeCode]: {
        type: Type.STRING,
        description: `The ${lang.native} translation.`
    },
    ...(requiresRomanization(lang.learningCode) ? {
        romanization: {
            type: Type.STRING,
            description: `Romanization/transcription of the ${lang.learning} phrase. This field is REQUIRED.`
        }
    } : {})
},
required: [lang.learningCode, lang.nativeCode, ...(requiresRomanization(lang.learningCode) ? ['romanization'] : [])]
```

Updated all mapping functions to extract `romanization` from the AI response:
*   `getCategoryAssistantResponse()`
*   `generateCardsFromTranscript()`
*   `generateCardsFromImage()`
*   `generateTopicCards()`

### 3. Card Creation Function Update

**File: `App.tsx`**

The `addCardsToCategory` function now correctly passes the romanization:

```typescript
const phrasesToAdd = cards.map(p => ({
  text: { native: p.native, learning: p.learning },
  category: targetCategory.id,
  ...(p.romanization ? { romanization: { learning: p.romanization } } : {})
}));
```

### 4. Existing Data Cleanup Script

**File: `scripts/cleanupPhraseRomanization.ts`**

Created a utility script that:
1.  Extracts romanization from phrase text (if it is in parentheses or square brackets)
2.  Cleans the phrase text of romanization
3.  Saves romanization to the correct `romanization.learning` field

Functions:
*   `extractRomanization(text)` - extracts romanization from text
*   `cleanupPhrase(phrase)` - processes a single phrase
*   `cleanupAllPhrases(phrases)` - processes all phrases with a report
*   `generateCleanupReport(result)` - generates a change report
*   `runCleanup()` - helper to run from browser console

**File: `components/DataCleanupModal.tsx`**

Created a React component to perform cleanup via UI with:
*   Analysis of existing phrases
*   Preview of changes
*   Confirmation before applying
*   Display of statistics and examples

## How to Use

### For New Phrases

New phrases generated by AI will now automatically have the correct structure:
*   Phrase text will be clean (no romanization in parentheses)
*   Romanization will be in a separate `romanization.learning` field

### For Existing Phrases

#### Option 1: Via UI (Recommended)

1.  Add `DataCleanupModal` to `App.tsx`:

```typescript
import DataCleanupModal from './components/DataCleanupModal';

// In App component
const [isDataCleanupModalOpen, setIsDataCleanupModalOpen] = useState(false);

// In JSX before the closing tag
<DataCleanupModal
    isOpen={isDataCleanupModalOpen}
    onClose={() => setIsDataCleanupModalOpen(false)}
    allPhrases={allPhrases}
    onUpdatePhrases={async (phrases) => {
        for (const phrase of phrases) {
            await backendService.updatePhrase(phrase.id, phrase);
        }
        // Update state
        updateAndSavePhrases(prev => {
            const updated = new Map(phrases.map(p => [p.id, p]));
            return prev.map(p => updated.get(p.id) || p);
        });
    }}
/>
```

2.  Add a button to open the modal in settings or menu

3.  Run cleanup via UI

#### Option 2: Via Browser Console

```javascript
// In browser console
import { runCleanup } from './scripts/cleanupPhraseRomanization';
await runCleanup();
```

## Languages Requiring Romanization

The `requiresRomanization()` function determines the following languages:
*   **Arabic** (`ar`) - Arabic transliteration
*   **Hindi** (`hi`) - Devanagari transliteration
*   **Chinese** (`zh`) - Pinyin
*   **Japanese** (`ja`) - Romaji

For these languages:
*   AI will **mandatorily** return the `romanization` field
*   Romanization will NOT be included in the phrase text
*   The data schema requires the presence of romanization

## Examples of Changes

### Before Cleanup:
```json
{
  "text": {
    "learning": "नमस्ते (namaste)"
  }
}
```

### After Cleanup:
```json
{
  "text": {
    "learning": "नमस्ते"
  },
  "romanization": {
    "learning": "namaste"
  }
}
```

## Result Verification

After applying changes:

1.  **New Phrases**: Create several new phrases via Category Assistant or Smart Import and check that:
    *   Phrase text does not contain romanization in parentheses
    *   Romanization is in a separate field

2.  **Existing Phrases**: Run the cleanup script and check the report

3.  **UI Display**: Ensure phrases are correctly displayed in cards

## Debugging

If something went wrong:

1.  **Check AI logs**: Look at responses from Gemini API in browser console
2.  **Check schema**: Ensure `requiresRomanization()` returns `true` for your language
3.  **Check prompt**: In `getCategoryAssistantResponse()` and other functions, check that the rule about romanization is added

## Additional Improvements (Optional)

1.  **Backend Validation**: Add check that for languages requiring romanization, the field is mandatory
2.  **Database Migration**: Create a migration for automatic cleanup when updating the application
3.  **UI Display**: Update PhraseCard to always show romanization under the phrase (if available)
4.  **Language Configuration**: Add ability to configure the list of languages requiring romanization

## Summary of File Changes

✅ **Changed:**
*   `types.ts` - added romanization field to ProposedCard
*   `services/geminiService.ts` - updated all schemas and generation functions
*   `App.tsx` - updated addCardsToCategory function

✨ **Created:**
*   `scripts/cleanupPhraseRomanization.ts` - data cleanup script
*   `components/DataCleanupModal.tsx` - UI for data cleanup
*   `ROMANIZATION_FIX_SUMMARY.md` - this documentation

## Testing

Recommended to test:
1. ✅ TypeScript Compilation - checked
2. ⏳ Generation of new phrases via Category Assistant
3. ⏳ Generation of phrases via Smart Import (transcripts, images, topics)
4. ⏳ Cleanup of existing phrases via UI
5. ⏳ Display of phrases with romanization in cards

---

Author: Claude Code
Date: 2025-10-13
